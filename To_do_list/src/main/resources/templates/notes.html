<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Notes</title>
    <style>
        :root { --pri:#667eea; --pri2:#764ba2; --ok:#4caf50; }
        *{box-sizing:border-box}
        body{
          margin:0; font-family:system-ui, Arial, sans-serif;
          min-height:100vh; background:linear-gradient(135deg,var(--pri),var(--pri2));
          color:#fff; padding:24px;
        }
        .nav-btn {
    display: inline-block;
    padding: 8px 16px;
    background-color: #667eea;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    cursor: pointer;
}
.nav-btn:hover {
    background-color: #5560c8;
}

        .container{max-width:980px;margin:0 auto}
        .card{background:#fff;color:#333;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:20px}
        header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
        .btn{border:0;border-radius:12px;padding:10px 14px;cursor:pointer;transition:.2s;font-weight:600}
        .btn.pri{background:var(--pri);color:#fff}
        .btn.ghost{background:#eef; color:#334}
        .toolbar{display:flex;gap:10px;flex-wrap:wrap}
        input[type="text"]{width:280px;max-width:100%;padding:10px 12px;border:1px solid #ccd;border-radius:10px}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-top:16px}
        .note{background:#f7f7ff;border:1px solid #e5e7f7;border-radius:14px;padding:12px;display:flex;flex-direction:column;gap:8px}
        .note h3{margin:0;font-size:1.05rem;color:#2b2e4a}
        .note small{color:#667}
        .note textarea{width:100%;min-height:120px;border:1px solid #dde;border-radius:10px;padding:10px;resize:vertical;background:#fff}
        .note .row{display:flex;gap:8px;justify-content:flex-end}
        .btn.warn{background:#ffe2e2;color:#b33}
        .btn.ok{background:var(--ok);color:#fff}
        .btn.open{background:#ffb74d;color:#fff}
        .editor{display:grid;gap:10px}
        .editor input, .editor textarea {width:100%;border:1px solid #ccd;border-radius:12px;padding:12px}
        .editor textarea{min-height:140px;resize:vertical}
        a.nav{color:#fff;opacity:.9;text-decoration:none}
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1 style="margin:0;">üóíÔ∏è Notes</h1>
        <nav class="toolbar">
            <a th:href="@{/pdf}" class="btn ghost">üìö PDF Library</a>
            <a href="#" class="nav">Home</a>
        </nav>
    </header>

    <!-- New Note Composer -->
    <div class="card">
        <h2 style="margin-top:0">Create a Note</h2>
        <div class="editor">
            <input id="newTitle" type="text" placeholder="Title" />
            <textarea id="newBody" placeholder="Write your note..."></textarea>

            <div style="display:flex;gap:8px;align-items:center;">
                <select id="newFolder"></select>
                <input id="newFolderInput" type="text" placeholder="Add new folder" />
                <button class="btn pri" id="addFolderBtn">Add</button>
            </div>

            <div style="display:flex;gap:8px;justify-content:flex-end">
                <button class="btn pri" id="saveNoteBtn">Save Note</button>
            </div>
        </div>
    </div>

    <!-- Search + Notes -->
    <div style="height:14px"></div>
    <div class="card">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between">
            <h2 style="margin:0">Your Notes</h2>

            <select id="folderFilter">
                <option value="">All Folders</option>
            </select>

            <input id="search" type="text" placeholder="Search notes..." />
        </div>
        <div class="grid" id="notesGrid"></div>
    </div>
</div>
<div style="text-align: left; margin-bottom: 20px;">
    <a th:href="@{/home}" class="nav-btn">
        ‚Üê Back to Home
    </a>
</div>



<script th:inline="javascript">
    let notes = /*[[${notes}]]*/ [];
    let folders = /*[[${folders}]]*/ [];

    const grid = document.getElementById("notesGrid");
    const newTitle = document.getElementById("newTitle");
    const newBody = document.getElementById("newBody");
    const newFolder = document.getElementById("newFolder");
    const newFolderInput = document.getElementById("newFolderInput");
    const addFolderBtn = document.getElementById("addFolderBtn");
    const search = document.getElementById("search");
    const folderFilter = document.getElementById("folderFilter");

    function populateFolders(){
    newFolder.innerHTML = "";
    folderFilter.innerHTML = '<option value="">All Folders</option>';
    folders.forEach(f => {
    const opt1 = document.createElement("option");
    opt1.value = f; opt1.textContent = f;
    newFolder.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = f; opt2.textContent = f;
    folderFilter.appendChild(opt2);
    });
    }
    populateFolders();

    addFolderBtn.addEventListener("click", ()=>{
    const name = newFolderInput.value.trim();
    if(!name) return;
    if(!folders.includes(name)) folders.push(name);
    newFolderInput.value = "";
    populateFolders();
    });

    const saveNoteBtn = document.getElementById("saveNoteBtn");
    saveNoteBtn.addEventListener("click", async ()=>{
    const title = newTitle.value.trim();
    const body = newBody.value.trim();
    const folder = newFolder.value || "General";
    if(!title && !body){ alert("Write something first üôÇ"); return; }

    const res = await fetch('/notes', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({title, body, folder})
    });
    const note = await res.json();
    notes.unshift(note);
    newTitle.value = ""; newBody.value = "";
    if(!folders.includes(note.folder)) { folders.push(note.folder); populateFolders(); }
    render();
    });

    search.addEventListener("input", render);
    folderFilter.addEventListener("change", render);

    function render(){
    const q = search.value.toLowerCase();
    const selectedFolder = folderFilter.value;
    const list = notes.filter(n =>
    ((n.title||"").toLowerCase().includes(q) || (n.body||"").toLowerCase().includes(q)) &&
    (!selectedFolder || n.folder === selectedFolder)
    );

    grid.innerHTML = "";
    list.forEach(n=>{
    const card = document.createElement("div");
    card.className = "note";

    card.innerHTML = `
    <input value="${escapeHtml(n.title||"")}" style="border:1px solid #dde;border-radius:10px;padding:8px;font-weight:700"/>
    <small>Updated: ${new Date(n.updatedAt).toLocaleString()} | Folder: </small>
    <select class="folderSelect"></select>
    <textarea>${escapeHtml(n.body||"")}</textarea>
    <div class="row">
        <button class="btn warn">Delete</button>
        <button class="btn ok">Save</button>
        <button class="btn open">Open</button>
    </div>
    `;

    const [titleInput, smallLabel, folderSelect, bodyEl, btnRow] = card.children;
    const delBtn = btnRow.children[0];
    const saveBtn = btnRow.children[1];
    const openBtn = btnRow.children[2];

    // Folder select options
    folderSelect.innerHTML = "";
    folders.forEach(f=>{
    const opt = document.createElement("option");
    opt.value = f; opt.textContent = f;
    folderSelect.appendChild(opt);
    });
    folderSelect.value = n.folder;

    // Update events
    titleInput.addEventListener("change", ()=> updateNoteField(n, {title: titleInput.value}));
    bodyEl.addEventListener("change", ()=> updateNoteField(n, {body: bodyEl.value}));
    folderSelect.addEventListener("change", ()=> updateNoteField(n, {folder: folderSelect.value}));

    delBtn.addEventListener("click", async ()=>{
    if(!confirm("Delete this note?")) return;
    await fetch(`/notes/${n.id}`, {method: 'DELETE'});
    notes = notes.filter(x=>x.id!==n.id);
    render();
    });

    saveBtn.addEventListener("click", ()=> updateNoteField(n, {
    title: titleInput.value,
    body: bodyEl.value,
    folder: folderSelect.value
    }));

    // Open note in new window
    openBtn.addEventListener("click", ()=>{
    const noteWindow = window.open("", "_blank", "width=600,height=500,scrollbars=yes");
    noteWindow.document.write(`
    <html>
    <head>
        <title>${escapeHtml(n.title || "Note")}</title>
        <style>
            body { font-family: Arial, sans-serif; padding: 20px; }
            h1 { margin-top: 0; }
            pre { white-space: pre-wrap; }
        </style>
    </head>
    <body>
    <h1>${escapeHtml(n.title || "Untitled")}</h1>
    <pre>${escapeHtml(n.body || "")}</pre>
    </body>
    </html>
    `);
    noteWindow.document.close();
    });

    grid.appendChild(card);
    });
    }

    async function updateNoteField(note, fields){
    const res = await fetch(`/notes/${note.id}`, {
    method: 'PUT',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({...note, ...fields})
    });
    const updated = await res.json();
    notes = notes.map(n=>n.id===updated.id ? updated : n);
    render();
    }

    function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }

    // Initial render
    render();
</script>
</body>
</html>
